### CVE-2021-4069

### PoC Links
[Huntr.dev](https://huntr.dev/bounties/0efd6d23-2259-4081-9ff1-3ade26907d74/)

### Docker Container Run Command
```shell
docker build -t cve-2021-4069-poc .
docker run -itd --name CVE-2021-4069-POC cve-2021-4069-poc
docker exec -it CVE-2021-4069-POC /bin/bash
```

### PoC Reproduce Command
```shell
# Preparing the initial environment
apt-get update -y
apt-get install git -y

# Configure local SSH for Github and clone the Vim repository. (ssh-keygen)
cd /poc
git clone git@github.com:vim/vim.git

# Rollback to the vulnerable version.
cd vim/
git reset --hard 021ef351c

# Install the compilation and installation dependencies for Vim.
apt install gcc make clang libtool-bin build-essential llvm-dev libunwind-dev -y

# Enter the `src` directory.
cd ./src

# Configure, compile, and install Vim.
LD=lld AS=llvm-as AR=llvm-ar RANLIB=llvm-ranlib CC=clang CXX=clang++ CFLAGS="-fsanitize=address" CXXFLAGS="-fsanitize=address" LDFLAGS="-ldl -fsanitize=address" ./configure --with-features=huge --enable-gui=none
make -j$(nproc)
make install

# Open the poc file.
vim -u NONE -X -Z -e -s -S /poc/poc.vim -c :qa!
or
ASAN_OPTIONS=detect_leaks=1 vim -u NONE -X -Z -e -s -S /poc/poc.vim -c :qa!
```

### Description
Observed that:
```shell
=================================================================
==8883==ERROR: AddressSanitizer: heap-use-after-free on address 0xffffa73072d1 at pc 0xaaaabd5df7f0 bp 0xfffffe3a8790 sp 0xfffffe3a8788
READ of size 1 at 0xffffa73072d1 thread T0
#0 0xaaaabd5df7ec  (/usr/local/bin/vim+0x7d57ec) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#1 0xaaaabd5dd45c  (/usr/local/bin/vim+0x7d345c) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#2 0xaaaabd5dbca0  (/usr/local/bin/vim+0x7d1ca0) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#3 0xaaaabd590f00  (/usr/local/bin/vim+0x786f00) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#4 0xaaaabd58e280  (/usr/local/bin/vim+0x784280) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#5 0xaaaabd58e8d8  (/usr/local/bin/vim+0x7848d8) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#6 0xaaaabd2857f0  (/usr/local/bin/vim+0x47b7f0) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#7 0xaaaabd2595e4  (/usr/local/bin/vim+0x44f5e4) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#8 0xaaaabd24e724  (/usr/local/bin/vim+0x444724) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#9 0xaaaabd64c13c  (/usr/local/bin/vim+0x84213c) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#10 0xaaaabd649c6c  (/usr/local/bin/vim+0x83fc6c) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#11 0xaaaabd64998c  (/usr/local/bin/vim+0x83f98c) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#12 0xaaaabd2595e4  (/usr/local/bin/vim+0x44f5e4) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#13 0xaaaabd24e724  (/usr/local/bin/vim+0x444724) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#14 0xaaaabd251008  (/usr/local/bin/vim+0x447008) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#15 0xaaaabd9ebd8c  (/usr/local/bin/vim+0xbe1d8c) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#16 0xaaaabd9e9a00  (/usr/local/bin/vim+0xbdfa00) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#17 0xaaaabd9e3998  (/usr/local/bin/vim+0xbd9998) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#18 0xffffaaad73f8  (/lib/aarch64-linux-gnu/libc.so.6+0x273f8) (BuildId: f37f3aa07c797e333fd106472898d361f71798f5)
#19 0xffffaaad74c8 in __libc_start_main (/lib/aarch64-linux-gnu/libc.so.6+0x274c8) (BuildId: f37f3aa07c797e333fd106472898d361f71798f5)
#20 0xaaaabcfd232c  (/usr/local/bin/vim+0x1c832c) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)

0xffffa73072d1 is located 1 bytes inside of 4-byte region [0xffffa73072d0,0xffffa73072d4)
freed by thread T0 here:
#0 0xaaaabd04924c in free (/usr/local/bin/vim+0x23f24c) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#1 0xaaaabd080c78  (/usr/local/bin/vim+0x276c78) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#2 0xaaaabd3eb180  (/usr/local/bin/vim+0x5e1180) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#3 0xaaaabd3f86f8  (/usr/local/bin/vim+0x5ee6f8) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#4 0xaaaabd3f8ca0  (/usr/local/bin/vim+0x5eeca0) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#5 0xaaaabd418744  (/usr/local/bin/vim+0x60e744) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#6 0xaaaabd7c2048  (/usr/local/bin/vim+0x9b8048) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#7 0xaaaabd3bbfcc  (/usr/local/bin/vim+0x5b1fcc) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#8 0xaaaabd3bba40  (/usr/local/bin/vim+0x5b1a40) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#9 0xaaaabd5e603c  (/usr/local/bin/vim+0x7dc03c) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#10 0xaaaabd5dd45c  (/usr/local/bin/vim+0x7d345c) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#11 0xaaaabd5dbca0  (/usr/local/bin/vim+0x7d1ca0) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#12 0xaaaabd590f00  (/usr/local/bin/vim+0x786f00) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#13 0xaaaabd58e280  (/usr/local/bin/vim+0x784280) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#14 0xaaaabd58e8d8  (/usr/local/bin/vim+0x7848d8) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#15 0xaaaabd2857f0  (/usr/local/bin/vim+0x47b7f0) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#16 0xaaaabd2595e4  (/usr/local/bin/vim+0x44f5e4) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#17 0xaaaabd24e724  (/usr/local/bin/vim+0x444724) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#18 0xaaaabd64c13c  (/usr/local/bin/vim+0x84213c) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#19 0xaaaabd649c6c  (/usr/local/bin/vim+0x83fc6c) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#20 0xaaaabd64998c  (/usr/local/bin/vim+0x83f98c) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#21 0xaaaabd2595e4  (/usr/local/bin/vim+0x44f5e4) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#22 0xaaaabd24e724  (/usr/local/bin/vim+0x444724) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#23 0xaaaabd251008  (/usr/local/bin/vim+0x447008) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#24 0xaaaabd9ebd8c  (/usr/local/bin/vim+0xbe1d8c) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#25 0xaaaabd9e9a00  (/usr/local/bin/vim+0xbdfa00) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#26 0xaaaabd9e3998  (/usr/local/bin/vim+0xbd9998) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#27 0xffffaaad73f8  (/lib/aarch64-linux-gnu/libc.so.6+0x273f8) (BuildId: f37f3aa07c797e333fd106472898d361f71798f5)
#28 0xffffaaad74c8 in __libc_start_main (/lib/aarch64-linux-gnu/libc.so.6+0x274c8) (BuildId: f37f3aa07c797e333fd106472898d361f71798f5)
#29 0xaaaabcfd232c  (/usr/local/bin/vim+0x1c832c) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)

previously allocated by thread T0 here:
#0 0xaaaabd0494e0 in __interceptor_malloc (/usr/local/bin/vim+0x23f4e0) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#1 0xaaaabd080818  (/usr/local/bin/vim+0x276818) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#2 0xaaaabd080760  (/usr/local/bin/vim+0x276760) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#3 0xaaaabd713008  (/usr/local/bin/vim+0x909008) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#4 0xaaaabd3f9450  (/usr/local/bin/vim+0x5ef450) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#5 0xaaaabd3f92f8  (/usr/local/bin/vim+0x5ef2f8) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#6 0xaaaabd241aa0  (/usr/local/bin/vim+0x437aa0) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#7 0xaaaabd2595e4  (/usr/local/bin/vim+0x44f5e4) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#8 0xaaaabd24e724  (/usr/local/bin/vim+0x444724) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#9 0xaaaabd64c13c  (/usr/local/bin/vim+0x84213c) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#10 0xaaaabd649c6c  (/usr/local/bin/vim+0x83fc6c) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#11 0xaaaabd64998c  (/usr/local/bin/vim+0x83f98c) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#12 0xaaaabd2595e4  (/usr/local/bin/vim+0x44f5e4) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#13 0xaaaabd24e724  (/usr/local/bin/vim+0x444724) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#14 0xaaaabd251008  (/usr/local/bin/vim+0x447008) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#15 0xaaaabd9ebd8c  (/usr/local/bin/vim+0xbe1d8c) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#16 0xaaaabd9e9a00  (/usr/local/bin/vim+0xbdfa00) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#17 0xaaaabd9e3998  (/usr/local/bin/vim+0xbd9998) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
#18 0xffffaaad73f8  (/lib/aarch64-linux-gnu/libc.so.6+0x273f8) (BuildId: f37f3aa07c797e333fd106472898d361f71798f5)
#19 0xffffaaad74c8 in __libc_start_main (/lib/aarch64-linux-gnu/libc.so.6+0x274c8) (BuildId: f37f3aa07c797e333fd106472898d361f71798f5)
#20 0xaaaabcfd232c  (/usr/local/bin/vim+0x1c832c) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)

SUMMARY: AddressSanitizer: heap-use-after-free (/usr/local/bin/vim+0x7d57ec) (BuildId: 58db421efcf9b55686db4a9349c46a2f4d06b538)
Shadow bytes around the buggy address:
0x200ff4e60e00: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
0x200ff4e60e10: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
0x200ff4e60e20: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
0x200ff4e60e30: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
0x200ff4e60e40: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
=>0x200ff4e60e50: fa fa fa fa fa fa 05 fa fa fa[fd]fa fa fa 04 fa
0x200ff4e60e60: fa fa 00 00 fa fa fd fa fa fa 04 fa fa fa fd fa
0x200ff4e60e70: fa fa fd fa fa fa 04 fa fa fa 04 fa fa fa 04 fa
0x200ff4e60e80: fa fa fd fd fa fa 00 02 fa fa fa fa fa fa fa fa
0x200ff4e60e90: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
0x200ff4e60ea0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
Shadow byte legend (one shadow byte represents 8 application bytes):
Addressable:           00
Partially addressable: 01 02 03 04 05 06 07
Heap left redzone:       fa
Freed heap region:       fd
Stack left redzone:      f1
Stack mid redzone:       f2
Stack right redzone:     f3
Stack after return:      f5
Stack use after scope:   f8
Global redzone:          f9
Global init order:       f6
Poisoned by user:        f7
Container overflow:      fc
Array cookie:            ac
Intra object redzone:    bb
ASan internal:           fe
Left alloca redzone:     ca
Right alloca redzone:    cb
==8883==ABORTING
```



