import os
import datetime
from peewee import *

db = MySQLDatabase('cve', host="localhost", user='root', passwd='20011202', port=3306)

class Poc(Model):
    id = BigIntegerField(primary_key=True)
    gmt_create = DateTimeField(default=datetime.datetime.now)
    gmt_modified = DateTimeField(default=datetime.datetime.now)
    cve_name = CharField(default='')
    poc_links = CharField(default='[]')
    exploit_status = BooleanField(default=False)
    year = IntegerField(default=None)
    platform = CharField(default='')
    language = CharField(default='')
    note = CharField(default='')
    del_status = IntegerField(default=0)

    class Meta:
        database = db
        table_name = 'poc'


ROOT_DIR = os.path.dirname(__file__)


def getNonExploitCveNameByLang(lang_list: []) -> {}:
    statistic = {}
    for lang in lang_list:
        statistic[lang] = {
            'EXPLOIT': 0,
            'UN_EXPLOIT': 0,
            'UN_EXPLOIT_LIST': [],
            'EXPLOIT_LIST': []
        }

    exploit_list = []
    un_exploit_list = []

    print(ROOT_DIR)
    for dirname, sub_dir_list, file_list in os.walk(ROOT_DIR):
        name = dirname.split('/')[-1]

        if name[:4] == 'CVE-':
            cve_name = '-'.join(name.split('-')[:3])
            poc = Poc.select().where(Poc.cve_name == cve_name).first()

            if poc is not None and poc.language in lang_list:
                if poc.exploit_status == 1:
                    statistic[poc.language]['EXPLOIT'] += 1
                    statistic[poc.language]['EXPLOIT_LIST'].append(poc.cve_name)
                else:
                    statistic[poc.language]['UN_EXPLOIT'] += 1
                    un_exploit_list.append(poc.cve_name)
                    statistic[poc.language]['UN_EXPLOIT_LIST'].append(poc.cve_name)

    return statistic


if __name__ == '__main__':
    statistic = getNonExploitCveNameByLang(['C', 'JS'])
    print(statistic)
